---
title: "TCC MBA USP/ESALQ"
author: "Ivaney Vieira de Sales"
date: "01/02/2022"
output:
html_document:
highlight: kate
theme: paper
toc: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
# Classificação de estabelecimentos concorrentes
## Carga de pacotes
```{r Carga de Pacotes }
pacotes <- c("tidyverse", "ggmap", "kableExtra", "sjPlot")

if (sum(as.numeric(!pacotes %in% installed.packages())) != 0) {
  instalador <- pacotes[!pacotes %in% installed.packages()]
  for (i in seq_along(instalador)) {
    install.packages(instalador, dependencies = T)
    break() }
  sapply(pacotes, require, character = T)
} else {
  sapply(pacotes, require, character = T)
}
```
## Funções uteis
```{r Funções uteis}
tabelaContgenciaCNAE <- function(df, cnae01, cnae02) {
  rows <- df[paste0("cnae", cnae01)]
  cols <- df[paste0("cnae", cnae02)]
  sjt.xtab(title = paste0("Tabela de Contigencia ente os CNAE ", cnae01, "x", cnae02),
           var.row = rows,
           var.col = cols,
           variableLabels = c(cnae01, cnae02),
           show.exp = TRUE,
           show.row.prc = TRUE,
           show.col.prc = TRUE)
}

tabela <- function(df, caption = "") {
  df %>%
    kable(caption = caption) %>%
    kable_styling(bootstrap_options = "striped",
                  full_width = TRUE,
                  font_size = 12)
}

strTable <- function(df, caption = "") {
  data.frame(variable = names(df),
             classe = sapply(df, typeof),
             first_values = sapply(df, function(x) paste0(head(x), collapse = ", ")),
             row.names = NULL) %>%
    tabela(caption = caption)
}

testeQui2 <- function(df, cnae01, cnae02) {
  rows <- df[paste0("cnae", cnae01)][, 1]
  cols <- df[paste0("cnae", cnae02)][, 1]
  table <- table(rows, cols)
  qui2 <- chisq.test(table)
  return(qui2)
}
```
## Carga e processamento da base de estabelecimentos

Será feia a carga do arquivo estabelecimento.txt. Essa arquivo foi extraído dos dados aberto da receita federal,
no endereço : http:/xxxx.xx.xx, foram aplicados os seguintes filtros:

* Localizados na cidade de Teresina Piauí;
* Atualmente em atividade; e
* Possui pelo menos um dos CNAE (Classificação Nacional de Atividades Econômicas) da Pintos.

```{r}
# Carrega o arquivo de cnaes
df.cnaes <- read.csv("cnae.txt", sep = ";")

cnaes.Pintos <- c(4751201, 4752100, 4753900, 4754701, 4755503, 4759899, 4763601, 4772500, 4781400, 4782201)

df.cnaes[order(df.cnaes$CODIGO),] %>%
  filter(CODIGO %in% cnaes.Pintos) %>%
  tabela()
```
```{r Carga e Processamento de estabelecimento}
df.estabelacimento.bruto <- read.csv("estabelecimentos.txt", sep = ";", dec = ",",
                                     colClasses = c("CNPJ_BASICO" = "character", "CNPJ_ORDEM" = "character", "CNPJ_DV" = "character",
                                                    "IDENTIFICADOR_MF" = "integer", "NOME_FANTASIA" = "character", "SITUACAO" = "integer",
                                                    "DATA_SITUACAO" = "character", "MOTIVO_SITUACAO" = "integer", "CIDADE_EXT" = "character",
                                                    "PAIS" = "integer", "DATA_ATIVIDADE" = "character", "CNAE_PRINCIPAL" = "integer",
                                                    "CNAE_SECUNDARIO" = "character", "TIPO_LOG" = "character", "LOGRADOURO" = "character",
                                                    "NUMERO" = "character", "COMPLEMENTO" = "character", "BAIRRO" = "character",
                                                    "CEP" = "character", "UF" = "factor", "MUNICIPIO" = "integer",
                                                    "DDD1" = "character", "TELEFONE1" = "character", "DDD2" = "character",
                                                    "TELEFONE2" = "character", "DDD_FAX" = "character", "FAX" = "character",
                                                    "EMAIL" = "character", "SITUACAO_ESPECIAL" = "character", "DATA_SITUACAO_ESPECIAL" = "integer",
                                                    "RAZAO_SOCIAL" = "character", "NATUREZA" = "integer", "QUALICACAO_RESPONSAVEL" = "integer",
                                                    "CAPITAL" = "numeric", "PORTE" = "integer", "ENTE_FED_RESPONSAVEL" = "character"
                                     ))

df.estabelacimento <- df.estabelacimento.bruto %>%
  transmute(
    cnpj = paste0(CNPJ_BASICO, CNPJ_ORDEM, CNPJ_DV),
    nome = NOME_FANTASIA,
    tipo = if_else(.$IDENTIFICADOR_MF == 1, 'MATRIZ',
                   if_else(.$IDENTIFICADOR_MF == 2, 'FILIAL', NULL)),
    situacao = if_else(.$SITUACAO == 1, "NULA",
                       if_else(.$SITUACAO == 2, "ATIVA",
                               if_else(.$SITUACAO == 3, "SUSPENSA",
                                       if_else(.$SITUACAO == 4, "INAPTA",
                                               if_else(.$SITUACAO == 8, "BAIXADA",
                                                       NULL))))),
    dataSituacao = .$DATA_SITUACAO %>% as.Date(format = "%Y%m%d"),
    dataAtividade = .$DATA_ATIVIDADE %>% as.Date(format = "%Y%m%d"),
    cnaePrincipal = .$CNAE_PRINCIPAL,
    cnaeSecundario = .$CNAE_SECUNDARIO %>% str_split(","),
    endereco = paste0(.$TIPO_LOG, " ", .$LOGRADOURO, ", ", .$COMPLEMENTO, " ", .$NUMERO, " - ",
                      .$BAIRRO, ", TERESINA - PI, "),
    cep = CEP,
    razaoSociao = RAZAO_SOCIAL,
    capital = CAPITAL,
    porte = if_else(.$PORTE == 0, "NÂO INFORMADO",
                    if_else(.$PORTE == 1, "MICRO EMPRESA",
                            if_else(.$PORTE == 3, "PEQUENO PORTE",
                                    if_else(.$PORTE == 5, "DEMAIS", NULL))))
  )

df.estabelacimento <- df.estabelacimento %>% add_column(
  cnaes = mapply(list, .$cnaePrincipal, .$cnaeSecundario, SIMPLIFY = F) %>% map(unlist)
)
```
## Data frame de estabelecimentos
```{r}
df.estabelacimento %>% strTable("Estabelecimento")
```

## Seleção dos dados para clusterização

```{r}
df.estabelacimento$cnae4751201 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4751201 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4752100 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4752100 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4753900 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4753900 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4754701 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4754701 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4755503 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4755503 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4759899 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4759899 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4763601 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4763601 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4772500 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4772500 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4781400 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4781400 %in% .x, 'S', 'N')) %>%
  unlist()
df.estabelacimento$cnae4782201 <- df.estabelacimento$cnaes %>%
  map(~ifelse(4782201 %in% .x, 'S', 'N')) %>%
  unlist()

df.estabelacimento.cnae <- df.estabelacimento %>%
        filter(situacao == "ATIVA") %>%
  select(cnpj,
         cnae4751201,
         cnae4752100,
         cnae4753900,
         cnae4754701,
         cnae4755503,
         cnae4759899,
         cnae4763601,
         cnae4772500,
         cnae4781400,
         cnae4782201)

df.estabelacimento.cnae %>% strTable("Estabelecimento CNAE")
```

## Teste qui2 para os parese de variáveis
```{r}
cnaes01 <- NULL
cnaes02 <- NULL
num01 <- NULL
num02 <- NULL
p.value <- NULL

for (i in seq_along(cnaes.Pintos)) {
  for (j in 1:i) {
    if (i != j) {
      num01 <- c(num01, i)
      num02 <- c(num02, j)
      cnaes01 <- c(cnaes01, cnaes.Pintos[i]) %>% as.character()
      cnaes02 <- c(cnaes02, cnaes.Pintos[j]) %>% as.character()
      qui2 <- testeQui2(df.estabelacimento.cnae, cnaes.Pintos[i], cnaes.Pintos[j])
      p.value <- c(p.value, qui2$p.value)
    }
  }
}

df.qui2 <- data.frame(num01, num02, cnaes01, cnaes02, p.value)

df.qui2 <- df.qui2[order(df.qui2$cnaes01, df.qui2$cnaes02),]

df.qui2[order(-df.qui2$p.value),] %>% tabela()

```

